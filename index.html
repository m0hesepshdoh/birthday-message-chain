<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birthday Chain</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="chain.ico" type="image/x-icon">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      --primary-color: #CF0820;
      --secondary-color: #000000;
      --background-color: #FFFFFF;
      font-size: 16px;
    }

    [dir="rtl"] body {
      font-family: 'Cairo', sans-serif;
    }

    [dir="rtl"] .text-right {
      text-align: left;
    }

    [dir="rtl"] .text-left {
      text-align: right;
    }

    [dir="rtl"] .wheel {
      border-right: none;
      border-left: 1px solid var(--primary-color);
    }

    [dir="rtl"] .wheel:first-child {
      border-left: none;
    }

    [dir="rtl"] input,
    [dir="rtl"] textarea {
      text-align: center;
    }

    [dir="rtl"] label {
      text-align: right;
      display: block;
    }

    .date-picker {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
      width: 100%;
    }

    .wheel-container {
      display: flex;
      overflow: hidden;
      width: 100%;
      height: 120px;
      border-radius: 5px;
      border: 1px solid var(--primary-color);
      background-color: var(--background-color);
    }

    .wheel {
      flex: 1;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
      border-right: 1px solid var(--primary-color);
      font-size: 16px;
    }

    .wheel:last-child {
      border-right: none;
    }

    .wheel::-webkit-scrollbar {
      display: none;
    }

    .wheel-item {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      scroll-snap-align: center;
    }

    .wheel-item.selected {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
    }

    .selected-date {
      font-size: 16px;
      margin-top: 10px;
      color: var(--secondary-color);
      text-align: center;
    }

    input,
    textarea,
    button {
      border-radius: 8px;
    }

    textarea {
      font-size: 16px;
    }

    .bg-blue-500 {
      border-radius: 8px;
    }

    .text-2xl {
      font-size: 24px;
    }

    .text-sm {
      font-size: 14px;
    }

    .text-gray-600 {
      font-size: 16px;
    }

    .text-gray-500 {
      font-size: 14px;
    }

    .w-full {
      width: 100%;
    }

    .h-32 {
      height: 128px;
    }

    .flex-center {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .error-message {
      color: red;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>

<body class="bg-black-100 flex justify-center items-center min-h-screen p-4">
  <div class="bg-white rounded-lg shadow-md p-6 w-full max-w-md">
    <div class="flex flex-col items-center mb-2">
      <h2 id="main-title" class="text-2xl font-semibold">Birthday Message Chain</h2>
      <button id="toggleLangBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-[0.1rem] px-1.5 text-[0.6rem] rounded mt-1">
        translate to
      </button>
    </div>

    <div class="mb-6">
      <p id="main-description" class="text-black-600 text-xl text-start grow">
        Join our birthday
      </p>
    </div>

    <form class="space-y-4" id="birthdayForm">
      <div>
        <label id="email-label" for="email" class="block text-black-700 text-sm font-bold mb-2">Email</label>
        <input type="email" id="email" name="email" placeholder="your@email.com" required class="border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center" />
        <div id="email-error" class="error-message"></div>
      </div>

      <div>
        <label id="birthday-label" class="block text-black-700 text-sm font-bold mb-2">Birthday (Month & Day)</label>
        <div class="date-picker">
          <div class="wheel-container">
            <div class="wheel" id="monthWheel"></div>
            <div class="wheel" id="dayWheel"></div>
          </div>
          <div class="selected-date" id="selectedDate">Selected Date: </div>
        </div>
      </div>

      <div>
        <label id="message-label" for="message" class="block text-black-700 text-sm font-bold mb-2">Your Birthday Message</label>
        <textarea id="message" name="message" placeholder="Write a heartfelt birthday message (max 100 characters)" required maxlength="300" class="border rounded w-full py-2 px-3 text-black-700 leading-tight focus:outline-none focus:shadow-outline h-32 resize-none text-center"></textarea>
        <p id="char-count" class="text-gray-500 text-xs text-right">0/100 characters</p>
        <div id="message-error" class="error-message"></div>
      </div>

      <button id="submit-button" type="submit" class="bg-[#CF0820] hover:bg-[#9d0618] text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">Join the Birthday Chain</button>
      <div id="form-success" class="text-green-500 text-center mt-4" style="display: none;"></div>
      <div id="form-error" class="text-red-500 text-center mt-4" style="display: none;"></div>
      <div id="ip-block-error" class="text-red-500 text-center mt-4" style="display: none;"></div>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: 'AIzaSyA0wcgv_6dH14g37F6fdqXv1A97amw23_w',
      authDomain: 'birthdaymessagesapp.firebaseapp.com',
      projectId: 'birthdaymessagesapp',
      storageBucket: 'birthdaymessagesapp.firebasestorage.app',
      messagingSenderId: '220266164498',
      appId: '1:220266164498:web:2adcb2520b75f580cd83cb'
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function getBrowserLanguage() {
      const userLang = navigator.language || navigator.userLanguage;
      if (userLang.startsWith('ar')) {
        return 'ar';
      }
      return 'en';
    }
    const translations = {
      en: {
        title: "Birthday Message Chain",
        description: "Join the chain of birthday messages. Your words will brighten someone's Birthday, In return you'll receive a surprise message from other's on your birthday!",
        emailLabel: "Your Email to Recive Other's Message",
        emailPlaceholder: " your@email.com ",
        birthdayLabel: "Your Birthday",
        selectedDatePrefix: "You've selected : ",
        messageLabel: "Birthday Message Other's Will Recive",
        messagePlaceholder: "Write Something Uniqe Be Creative And Kind (max 100 characters)",
        charCountSuffix: "characters",
        submitButtonText: "Join The Birthday Chain",
        submitButtonJoining: "Joining...",
        formSuccessMessage: "You have joined the Chain Woohoo!",
        formGenericError: "Please correct the errors above.",
        formSubmitError: "Failed to join the chain. Please try again.",
        toggleButtonToAr: "العربية",
        months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
        emailValidationError: "Please enter a valid hotmail, Gmail or Yahoo etc... address.",
        messageRequiredError: "Message is required.",
        messageLengthError: "Message must be 100 characters or less.",
        ipBlockedError: "You have exceeded the maximum submission attempts."
      },
      ar: {
        title: "سلسلة رسائل ذكرى الولادة",
        description: "انظم إلى سلسلتنا لرسائل ذكرى الولادة السنوية كلماتك الحلوة بتخلي يوم ميلاد شخص ثاني أحلى وبالمقابل في يوم ميلادك بتجيك رسالة عشوائية",
        emailLabel: "بريدك الإلكتروني الخاص",
        emailPlaceholder: " your@email.com ",
        birthdayLabel: "تاريخ ميلادك (الشهر واليوم)",
        selectedDatePrefix: "اختيارك : ",
        messageLabel: "الرسالة إللي بتوصل لإيميل شخص ما",
        messagePlaceholder: "اكتب شي جديد وغريب وبنفس الوقت خاص ليوم الميلاد (100 حرف)",
        charCountSuffix: "حرف",
        submitButtonText: "انضم إلى السلسلة",
        submitButtonJoining: "جار الانضمام...",
        formSuccessMessage: "شكراً لانضمامك إلى سلسلة رسائل ذكرى يوم الولادة",
        formGenericError: "في عندك أخطاء فوق صلحها",
        formSubmitError: "في مشكلة , ممكن تعيد مرة ثانية",
        toggleButtonToEn: "English",
        months: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
        emailValidationError: "استخدم بريد إلكتروني زي هوتميل، جيميل أو ياهو إلخ...",
        messageRequiredError: "لازم تكتب رسالة",
        messageLengthError: "أكثر شي 100 حرف",
        ipBlockedError: "تجاوزت الحد الأقصى لعدد محاولات الإرسال."
      }
    };
    const englishNumericInput = document.getElementById('email');
    const monthWheel = document.getElementById('monthWheel');
    const dayWheel = document.getElementById('dayWheel');
    const selectedDateDisplay = document.getElementById('selectedDate');
    const messageInput = document.getElementById('message');
    const charCountDisplay = document.getElementById('char-count');
    const birthdayForm = document.getElementById('birthdayForm');
    const emailInput = document.getElementById('email');
    const formSuccess = document.getElementById('form-success');
    const formError = document.getElementById('form-error');
    const toggleLangBtn = document.getElementById('toggleLangBtn');
    const submitButton = document.getElementById('submit-button');
    const mainTitle = document.getElementById('main-title');
    const mainDescription = document.getElementById('main-description');
    const emailLabel = document.getElementById('email-label');
    const birthdayLabel = document.getElementById('birthday-label');
    const messageLabel = document.getElementById('message-label');
    const emailErrorDiv = document.getElementById('email-error');
    const messageErrorDiv = document.getElementById('message-error');
    const blockedEmail = "sepshdoh@gmail.com";
    const ipBlockErrorDiv = document.getElementById('ip-block-error');
    const BLOCKED_ATTEMPTS = 3;
    let selectedMonth = 0;
    let selectedDay = 1;
    englishNumericInput.addEventListener('input', function() {
      this.value = this.value.replace(/[^a-zA-Z0-9@_+.-\s]/g, '');
    });

    function populateWheel(wheel, items, selectedIndex = 0) {
      wheel.innerHTML = '';
      const fragment = document.createDocumentFragment();
      items.forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.classList.add('wheel-item');
        itemElement.textContent = item;
        itemElement.dataset.index = index;
        if (index === selectedIndex) {
          itemElement.classList.add('selected');
        }
        itemElement.addEventListener('click', () => {
          handleItemClick(wheel, index);
          itemElement.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        });
        fragment.appendChild(itemElement);
      });
      wheel.appendChild(fragment);
      setTimeout(() => {
        const selectedEl = wheel.querySelector('.wheel-item.selected');
        if (selectedEl) {
          selectedEl.scrollIntoView({
            behavior: 'auto',
            block: 'center'
          });
        }
      }, 50);
    }

    function generateDays(monthIndex) {
      const daysInMonth = (monthIndex === 1) ? 29 : new Date(2024, monthIndex + 1, 0).getDate();
      const days = Array.from({
        length: daysInMonth
      }, (_, i) => i + 1);
      selectedDay = Math.min(selectedDay, daysInMonth);
      populateWheel(dayWheel, days, selectedDay - 1);
    }

    function handleItemClick(wheel, index) {
      const items = wheel.querySelectorAll('.wheel-item');
      items.forEach(item => item.classList.remove('selected'));
      const targetItem = items[index];
      targetItem.classList.add('selected');
      if (wheel === monthWheel) {
        if (selectedMonth !== index) {
          selectedMonth = index;
          generateDays(selectedMonth);
        }
      } else {
        selectedDay = index + 1;
      }
      updateSelectedDate();
    }

    function updateSelectedDate() {
      const currentMonths = translations[currentLang].months;
      selectedDateDisplay.textContent = `${translations[currentLang].selectedDatePrefix}${currentMonths[selectedMonth]} ${selectedDay}`;
    }

    function applyTranslations() {
      const langData = translations[currentLang];
      const isRTL = currentLang === 'ar';
      document.documentElement.lang = currentLang;
      document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
      mainTitle.textContent = langData.title;
      mainDescription.textContent = langData.description;
      emailLabel.textContent = langData.emailLabel;
      emailInput.placeholder = langData.emailPlaceholder;
      birthdayLabel.textContent = langData.birthdayLabel;
      messageLabel.textContent = langData.messageLabel;
      messageInput.placeholder = langData.messagePlaceholder;
      submitButton.textContent = langData.submitButtonText;
      toggleLangBtn.textContent = isRTL ? langData.toggleButtonToEn : langData.toggleButtonToAr;
      populateWheel(monthWheel, langData.months, selectedMonth);
      updateSelectedDate();
      updateCharCount();
      emailErrorDiv.textContent = "";
      messageErrorDiv.textContent = "";
      formError.textContent = "";
      formSuccess.textContent = "";
      formError.style.display = 'none';
      formSuccess.style.display = 'none';
      ipBlockErrorDiv.style.display = 'none';
    }

    function updateCharCount() {
      const langData = translations[currentLang];
      charCountDisplay.textContent = `${messageInput.value.length}/100 ${langData.charCountSuffix}`;
      charCountDisplay.className = `text-gray-500 text-xs text-right ${currentLang === 'ar' ? 'text-right' : 'text-right'}`;
    }

    function toggleLanguage() {
      currentLang = (currentLang === 'en') ? 'ar' : 'en';
      applyTranslations();
      generateDays(selectedMonth);
      updateSelectedDate();
      updateCharCount();
    }
    messageInput.addEventListener('input', updateCharCount);

    function validateEmail(email) {
      const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((hotmail|gmail|yahoo|icloud|ftu|outlook)\.(com|co\.uk|ac.th|ca|de|fr|net|org|[a-z]{2,}))$/i;
      return re.test(String(email).toLowerCase());
    }

    function getIpAddress() {
      return fetch('https://api64.ipify.org?format=json')
        .then(response => response.json())
        .then(data => data.ip)
        .catch(error => {
          console.error("Failed to fetch IP address:", error);
          return '127.0.0.1';
        });
    }
    async function checkIpAndSubmit(event) {
      event.preventDefault();
      formError.style.display = 'none';
      formSuccess.style.display = 'none';
      ipBlockErrorDiv.style.display = 'none';
      emailErrorDiv.textContent = "";
      messageErrorDiv.textContent = "";
      submitButton.disabled = true;
      submitButton.textContent = translations[currentLang].submitButtonJoining;
      const email = emailInput.value.trim();
      const message = messageInput.value.trim();
      let hasErrors = false;
      const langData = translations[currentLang];
      if (!validateEmail(email)) {
        emailErrorDiv.textContent = langData.emailValidationError;
        hasErrors = true;
      } else {
        emailErrorDiv.textContent = "";
      }
      if (email.toLowerCase() === blockedEmail.toLowerCase()) {
        const blockedEmailMessage = currentLang === 'ar' ?
          'هذا البريد الإلكتروني حقي' :
          'This email address is mine.';
        emailErrorDiv.textContent = blockedEmailMessage;
        hasErrors = true;
      }
      if (!message) {
        messageErrorDiv.textContent = langData.messageRequiredError;
        hasErrors = true;
      } else if (message.length > 100) {
        messageErrorDiv.textContent = langData.messageLengthError;
        hasErrors = true;
      } else {
        messageErrorDiv.textContent = "";
      }
      if (hasErrors) {
        formError.textContent = langData.formGenericError;
        formError.style.display = 'block';
        submitButton.disabled = false;
        submitButton.textContent = langData.submitButtonText;
        return;
      }
      try {
        const ipAddress = await getIpAddress();
        const attemptsRef = db.collection('ipAttempts').doc(ipAddress);
        const doc = await attemptsRef.get();
        if (doc.exists) {
          const attemptsData = doc.data();
          const attempts = attemptsData.attempts || 0;
          if (attempts >= BLOCKED_ATTEMPTS) {
            ipBlockErrorDiv.textContent = langData.ipBlockedError;
            ipBlockErrorDiv.style.display = 'block';
            submitButton.disabled = false;
            submitButton.textContent = langData.submitButtonText;
            return;
          }
        }
        const formData = {
          email: email,
          birthMonth: selectedMonth + 1,
          birthDay: selectedDay,
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          ipAddress: ipAddress
        };
        await db.collection("submissions").add(formData);
        console.log("Document written successfully");
        if (doc.exists) {
          await attemptsRef.update({
            attempts: firebase.firestore.FieldValue.increment(1)
          });
        } else {
          await attemptsRef.set({
            attempts: 1
          });
        }
        formSuccess.textContent = langData.formSuccessMessage;
        formSuccess.style.display = 'block';
        birthdayForm.reset();
        selectedMonth = 0;
        selectedDay = 1;
        populateWheel(monthWheel, langData.months, selectedMonth);
        generateDays(selectedMonth);
        updateSelectedDate();
        updateCharCount();
        emailErrorDiv.textContent = "";
        messageErrorDiv.textContent = "";
      } catch (error) {
        console.error("Error adding document: ", error);
        formError.textContent = `${langData.formSubmitError} (${error.message})`;
        formError.style.display = 'block';
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = langData.submitButtonText;
      }
    }
    toggleLangBtn.addEventListener('click', toggleLanguage);
    birthdayForm.addEventListener('submit', checkIpAndSubmit);
    document.addEventListener('DOMContentLoaded', (event) => {
      console.log("DOM fully loaded and parsed");
      currentLang = getBrowserLanguage();
      applyTranslations();
      generateDays(selectedMonth);
      updateSelectedDate();
      updateCharCount();
    });
  </script>
</body>

</html>
