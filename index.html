<!DOCTYPE html>
<!-- this is the starting of the code -->
<html lang="en" dir="ltr">
<!-- here i choose the default language of the page -->
<head>
  <!-- this is the head of the code -->
  <meta charset="UTF-8" />
  <!-- help the browser to identify how to read the html -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- to adjust the size of my document with user phone/PC-->
  <title>Birthday Chain</title>
  <!-- title of the document-->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <!-- calling font from google fonts by an API where the size of the font is adjusted, it is free to use also linking it to the style-->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- this bring a JS that have tailwindcss -->
  <link rel="icon" href="chain.ico" type="image/x-icon">
    <!-- adding an icon in browser tab -->
  <style>
  /*here is the start of css code*/
    body {
      font-family: 'Inter', sans-serif;
      --primary-color: #CF0820;
      --secondary-color: #000000;
      --background-color: #FFFFFF;
      font-size: clamp(14px, 2.5vw, 16px);
    }

    [dir="rtl"] body {
      font-family: 'Cairo', sans-serif;
    }

    [dir="rtl"] .text-right {
      text-align: left;
    }

    [dir="rtl"] .text-left {
      text-align: right;
    }

    [dir="rtl"] .wheel {
      border-right: none;
      border-left: 1px solid var(--primary-color);
    }

    [dir="rtl"] .wheel:first-child {
      border-left: none;
    }

    [dir="rtl"] input,
    [dir="rtl"] textarea {
      text-align: center;
    }

    [dir="rtl"] label {
      text-align: right;
      display: block;
    }

    #main-title,
    .date-picker,
    .flex.flex-col.items-center.mb-2 {
      width: 100%;
    }

    #main-title {
      font-size: 1.5rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .date-picker {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .wheel-container {
      display: flex;
      overflow: hidden;
      width: 100%;
      height: 120px;
      border-radius: 5px;
      border: 1px solid var(--primary-color);
      background-color: var(--background-color);
    }

    .wheel {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      border-right: 1px solid var(--primary-color);
      font-size: 16px;
    }

    .wheel:last-child {
      border-right: none;
    }

    .wheel::-webkit-scrollbar {
      display: none;
    }

    .wheel-item {
      height: 40px;
      line-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
    }

    .wheel-item.selected {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
    }

    .selected-date {
      font-size: 16px;
      margin-top: 10px;
      color: var(--secondary-color);
      text-align: center;
    }

    input,
    textarea,
    button,
    .bg-blue-500 {
      border-radius: 8px;
    }

    textarea,
    .text-gray-600 {
      font-size: clamp(14px, 3vw, 16px);
    }

    .text-2xl {
      font-size: clamp(1.1rem, 5vw, 1.5rem);
    }

    .text-sm,
    .text-gray-500 {
      font-size: clamp(12px, 3vw, 14px);
    }

    .w-full {
      width: 100%;
    }

    .h-32 {
      height: clamp(100px, 30vw, 128px);
    }

    .flex-center {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .error-message {
      color: red;
      font-size: clamp(12px, 3vw, 14px);
      margin-top: 5px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: clamp(10px, 3vw, 20px);
    }

    .main-description {
      font-size: clamp(14px, 3.5vw, 18px);
      line-height: 1.4;
      margin-bottom: clamp(10px, 3vw, 20px);
    }

    .toggle-button {
      font-size: clamp(10px, 2.5vw, 12px);
      padding: clamp(2px, 1vw, 4px) clamp(4px, 2vw, 8px);
    }

    .form-group {
      margin-bottom: clamp(10px, 3vw, 16px);
    }

    input,
    textarea {
      padding: clamp(6px, 2vw, 8px) clamp(8px, 3vw, 12px);
      font-size: clamp(14px, 3vw, 16px);
    }

    .submit-button {
      font-size: clamp(14px, 3.5vw, 16px);
      padding: clamp(8px, 2vw, 8px) clamp(12px, 3vw, 16px);
    }
  </style>
  <!--end of style-->
</head>
  <!--start of the head-->
<body class="bg-black-100 flex justify-center items-center min-h-screen p-4">
  <!-- adjusting it to center -->
  <div class="container bg-white rounded-lg shadow-md p-4 sm:p-6 w-full">
    <!--making background white, rounding edges, shadow, keep distance from others -->
    <div class="flex flex-col items-center mb-2">
      <!--to make inside this class element flex to center at anytime -->
      <h2 id="main-title" class="text-2xl font-semibold">Birthday Message Chain</h2>
      <!--using 2nd heading title to write while changing the font making it bold-->
      <button id="toggleLangBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-1 px-2 rounded mt-2 toggle-button">translate to</button>
      <!-- translation button where its gray and text is white bold font rounded edge and it is button on click -->
    </div>
<!-- start of other things in my webpage-->
    <div class="mb-4 sm:mb-6">
      <!--in big screen 4 in small screen 6 -->
      <p id="main-description" class="text-black-600 main-description text-start grow">Join our birthday</p>
      <!-- a description paragraph, black color grow with websize -->
    </div>
<!--start of other things in my webpage -->
    <form class="space-y-4" id="birthdayForm">
      <!--form to fill-->
      <div class="form-group">
        <!-- -->
        <label id="email-label" for="email" class="block text-black-700 text-sm font-bold mb-1 sm:mb-2">Email</label>
        <input type="email" id="email" name="email" placeholder="your@email.com" required class="border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center" />
        <div id="email-error" class="error-message"></div>
      </div>

      <div class="form-group">
        <label id="birthday-label" class="block text-black-700 text-sm font-bold mb-1 sm:mb-2">Birthday (Month & Day)</label>
        <div class="date-picker">
          <div class="wheel-container">
            <div class="wheel" id="monthWheel"></div>
            <div class="wheel" id="dayWheel"></div>
          </div>
          <div class="selected-date" id="selectedDate">Selected Date: </div>
        </div>
      </div>

      <div class="form-group">
        <label id="message-label" for="message" class="block text-black-700 text-sm font-bold mb-1 sm:mb-2">Your Birthday Message</label>
        <textarea id="message" name="message" placeholder="Write a heartfelt birthday message (max 100 characters)" required maxlength="300" class="border rounded w-full py-2 px-3 text-black-700 leading-tight focus:outline-none focus:shadow-outline h-32 resize-none text-center"></textarea>
        <p id="char-count" class="text-gray-500 text-xs text-right">0/100 characters</p>
        <div id="message-error" class="error-message"></div>
      </div>

      <button id="submit-button" type="submit" class="bg-[#CF0820] hover:bg-[#9d0618] text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full submit-button">Join the Birthday Chain</button>
      <div id="form-success" class="text-green-500 text-center mt-4 hidden"></div>
      <div id="form-error" class="text-red-500 text-center mt-4 hidden"></div>
      <div id="ip-block-error" class="text-red-500 text-center mt-4 hidden"></div>
    </form>
  </div>

  <script src="https://cdn.polyfill.io/v3/polyfill.min.js?features=default,es6,es7,fetch"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: 'AIzaSyA0wcgv_6dH14g37F6fdqXv1A97amw23_w',
      authDomain: 'birthdaymessagesapp.firebaseapp.com',
      projectId: 'birthdaymessagesapp',
      storageBucket: 'birthdaymessagesapp.firebasestorage.app',
      messagingSenderId: '220266164498',
      appId: '1:220266164498:web:2adcb2520b75f580cd83cb'
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const translations = {
      en: {
        title: "Birthday Message Chain",
        description: "Join the birthday message chain! Your words will brighten someone's day, and you'll receive a surprise message on your birthday in return.",
        emailLabel: "Your Email to Recive Other's Message",
        emailPlaceholder: " your@email.com ",
        birthdayLabel: "Your Birthday",
        selectedDatePrefix: "You've selected : ",
        messageLabel: "Birthday Message Other's Will Recive",
        messagePlaceholder: "Write Something Uniqe Be Creative And Kind (max 100 characters)",
        charCountSuffix: "characters",
        submitButtonText: "Join The Birthday Chain",
        submitButtonJoining: "Joining...",
        formSuccessMessage: "You have joined the Chain Woohoo!",
        formGenericError: "Please correct the errors above.",
        formSubmitError: "Failed to join the chain. Please try again.",
        toggleButtonToAr: "العربية",
        months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
        emailValidationError: "Please enter a valid hotmail, Gmail or Yahoo etc... address.",
        messageRequiredError: "Message is required.",
        messageLengthError: "Message must be 100 characters or less.",
        ipBlockedError: "You have exceeded the maximum submission attempts."
      },
      ar: {
        title: "سلسلة رسائل يوم الولادة",
        description: "تعال شاركنا في سلسلة رسائل يوم الميلاد! كلمة منك ممكن تفرّح واحد ما تعرفه، وفي يوم ميلادك راح توصلك رسالة حلوة من شخص ما تعرفه.",
        emailLabel: "بريدك الإلكتروني الخاص",
        emailPlaceholder: " your@email.com ",
        birthdayLabel: "تاريخ ميلادك (الشهر واليوم)",
        selectedDatePrefix: "اختيارك : ",
        messageLabel: "الرسالة إللي بتوصل لواحد ما تعرفه",
        messagePlaceholder: "اكتب شي جديد وغريب وبنفس الوقت خاص ليوم الميلاد (100 حرف)",
        charCountSuffix: "حرف",
        submitButtonText: "ادخل السلسلة",
        submitButtonJoining: "قاعد تدخل...",
        formSuccessMessage: "أشكرك على انضمامك في السلسلة",
        formGenericError: "في عندك أخطاء فوق صلحها",
        formSubmitError: "في مشكلة , ممكن تعيد مرة ثانية",
        toggleButtonToEn: "English",
        months: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
        emailValidationError: "استخدم بريد إلكتروني زي هوتميل، جيميل أو ياهو إلخ...",
        messageRequiredError: "لازم تكتب رسالة",
        messageLengthError: "أكثر شي 100 حرف",
        ipBlockedError: "كم مرة ترسل يا خوي جرب في يوم ثاني"
      }
    };
    const elements = {
      email: document.getElementById('email'),
      monthWheel: document.getElementById('monthWheel'),
      dayWheel: document.getElementById('dayWheel'),
      selectedDate: document.getElementById('selectedDate'),
      message: document.getElementById('message'),
      charCount: document.getElementById('char-count'),
      birthdayForm: document.getElementById('birthdayForm'),
      formSuccess: document.getElementById('form-success'),
      formError: document.getElementById('form-error'),
      toggleLangBtn: document.getElementById('toggleLangBtn'),
      submitButton: document.getElementById('submit-button'),
      mainTitle: document.getElementById('main-title'),
      mainDescription: document.getElementById('main-description'),
      emailLabel: document.getElementById('email-label'),
      birthdayLabel: document.getElementById('birthday-label'),
      messageLabel: document.getElementById('message-label'),
      emailError: document.getElementById('email-error'),
      messageError: document.getElementById('message-error'),
      ipBlockError: document.getElementById('ip-block-error')
    };
    const blockedEmail = "ug671431015@ftu.ac.th";
    const BLOCKED_ATTEMPTS = 3;
    let selectedMonth = 0,
      selectedDay = 1,
      currentLang;
    elements.email.addEventListener('input', () => {
      elements.email.value = elements.email.value.replace(/[^a-zA-Z0-9@_+.-\s]/g, '');
    });
    const populateWheel = (wheel, items, selectedIndex = 0) => {
      wheel.innerHTML = '';
      const fragment = document.createDocumentFragment();
      items.forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.className = 'wheel-item' + (index === selectedIndex ? ' selected' : '');
        itemElement.textContent = item;
        itemElement.dataset.index = index;
        itemElement.addEventListener('click', () => {
          handleItemClick(wheel, index);
          itemElement.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        });
        fragment.appendChild(itemElement);
      });
      wheel.appendChild(fragment);
    };
    const generateDays = monthIndex => {
      const daysInMonth = (monthIndex === 1) ? 29 : new Date(2024, monthIndex + 1, 0).getDate();
      const days = Array.from({
        length: daysInMonth
      }, (_, i) => i + 1);
      selectedDay = Math.min(selectedDay, daysInMonth);
      populateWheel(elements.dayWheel, days, selectedDay - 1);
    };
    const handleItemClick = function(wheel, index) {
      var items = wheel.querySelectorAll('.wheel-item');
      for (var i = 0; i < items.length; i++) {
        items[i].classList.remove('selected');
      }
      wheel.children[index].classList.add('selected');
      var scrollPos = index * 40 - wheel.clientHeight / 2 + 20;
      wheel.scrollTop = scrollPos;
      if (wheel === elements.monthWheel && selectedMonth !== index) {
        selectedMonth = index;
        generateDays(selectedMonth);
      } else {
        selectedDay = index + 1;
      }
      updateSelectedDate();
    };
    const updateSelectedDate = () => {
      elements.selectedDate.textContent = `${translations[currentLang].selectedDatePrefix}${translations[currentLang].months[selectedMonth]} ${selectedDay}`;
    };
    const applyTranslations = () => {
      const langData = translations[currentLang];
      const isRTL = currentLang === 'ar';
      document.documentElement.lang = currentLang;
      document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
      elements.mainTitle.textContent = langData.title;
      elements.mainDescription.textContent = langData.description;
      elements.emailLabel.textContent = langData.emailLabel;
      elements.email.placeholder = langData.emailPlaceholder;
      elements.birthdayLabel.textContent = langData.birthdayLabel;
      elements.messageLabel.textContent = langData.messageLabel;
      elements.message.placeholder = langData.messagePlaceholder;
      elements.submitButton.textContent = langData.submitButtonText;
      elements.toggleLangBtn.textContent = isRTL ? langData.toggleButtonToEn : langData.toggleButtonToAr;
      populateWheel(elements.monthWheel, langData.months, selectedMonth);
      updateSelectedDate();
      updateCharCount();
      [elements.emailError, elements.messageError, elements.formError, elements.formSuccess, elements.ipBlockError].forEach(el => {
        el.textContent = "";
        el.style.display = 'none';
      });
    };
    const updateCharCount = () => {
      const langData = translations[currentLang];
      elements.charCount.textContent = `${elements.message.value.length}/100 ${langData.charCountSuffix}`;
    };
    const toggleLanguage = () => {
      currentLang = currentLang === 'en' ? 'ar' : 'en';
      applyTranslations();
      generateDays(selectedMonth);
    };
    elements.message.addEventListener('input', updateCharCount);
    const validateEmail = email => /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((hotmail|gmail|yahoo|icloud|ftu|outlook)\.(com|co\.uk|ac.th|ca|de|fr|net|org|[a-z]{2,}))$/i.test(String(email).toLowerCase());
    const getIpAddress = function() {
      return new Promise(function(resolve) {
        if (window.fetch) {
          fetch('https://api64.ipify.org?format=json')
            .then(function(response) {
              return response.json();
            })
            .then(function(data) {
              resolve(data.ip);
            })
            .catch(function() {
              resolve('127.0.0.1');
            });
        } else {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', 'https://api64.ipify.org?format=json', true);
          xhr.onload = function() {
            try {
              var data = JSON.parse(xhr.responseText);
              resolve(data.ip || '127.0.0.1');
            } catch (e) {
              resolve('127.0.0.1');
            }
          };
          xhr.onerror = function() {
            resolve('127.0.0.1');
          };
          xhr.send();
        }
      });
    };
    const checkIpAndSubmit = async event => {
      event.preventDefault();
      [elements.formError, elements.formSuccess, elements.ipBlockError].forEach(el => el.style.display = 'none');
      [elements.emailError, elements.messageError].forEach(el => el.textContent = "");
      elements.submitButton.disabled = true;
      elements.submitButton.textContent = translations[currentLang].submitButtonJoining;
      const email = elements.email.value.trim();
      const message = elements.message.value.trim();
      const langData = translations[currentLang];
      let hasErrors = false;
      if (!validateEmail(email)) {
        elements.emailError.textContent = langData.emailValidationError;
        hasErrors = true;
      } else if (email.toLowerCase() === blockedEmail.toLowerCase()) {
        elements.emailError.textContent = currentLang === 'ar' ? 'هذا البريد الإلكتروني حقي' : 'This email address is mine.';
        hasErrors = true;
      }
      if (!message) {
        elements.messageError.textContent = langData.messageRequiredError;
        hasErrors = true;
      } else if (message.length > 100) {
        elements.messageError.textContent = langData.messageLengthError;
        hasErrors = true;
      }
      if (hasErrors) {
        elements.formError.textContent = langData.formGenericError;
        elements.formError.style.display = 'block';
        elements.submitButton.disabled = false;
        elements.submitButton.textContent = langData.submitButtonText;
        return;
      }
      try {
        const ipAddress = await getIpAddress();
        const attemptsRef = db.collection('ipAttempts').doc(ipAddress);
        const doc = await attemptsRef.get();
        if (doc.exists && doc.data().attempts >= BLOCKED_ATTEMPTS) {
          elements.ipBlockError.textContent = langData.ipBlockedError;
          elements.ipBlockError.style.display = 'block';
          elements.submitButton.disabled = false;
          elements.submitButton.textContent = langData.submitButtonText;
          return;
        }
        await db.collection("submissions").add({
          email: email,
          birthMonth: selectedMonth + 1,
          birthDay: selectedDay,
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          ipAddress: ipAddress
        });
        await (doc.exists ?
          attemptsRef.update({
            attempts: firebase.firestore.FieldValue.increment(1)
          }) :
          attemptsRef.set({
            attempts: 1
          }));
        elements.formSuccess.textContent = langData.formSuccessMessage;
        elements.formSuccess.style.display = 'block';
        elements.birthdayForm.reset();
        selectedMonth = 0;
        selectedDay = 1;
        populateWheel(elements.monthWheel, langData.months, selectedMonth);
        generateDays(selectedMonth);
        updateSelectedDate();
        updateCharCount();
      } catch (error) {
        console.error("Error adding document: ", error);
        elements.formError.textContent = `${langData.formSubmitError} (${error.message})`;
        elements.formError.style.display = 'block';
      } finally {
        elements.submitButton.disabled = false;
        elements.submitButton.textContent = langData.submitButtonText;
      }
    };
    elements.toggleLangBtn.addEventListener('click', toggleLanguage);
    elements.birthdayForm.addEventListener('submit', checkIpAndSubmit);
    document.addEventListener('DOMContentLoaded', function() {
      currentLang = (navigator.language && navigator.language.startsWith('ar')) ? 'ar' : 'en';
      setTimeout(function() {
        applyTranslations();
        generateDays(selectedMonth);
        var wheelItems = document.querySelectorAll('.wheel-item');
        for (var i = 0; i < wheelItems.length; i++) {
          wheelItems[i].addEventListener('touchstart', function(e) {
            e.preventDefault();
            handleItemClick(this.parentNode, parseInt(this.dataset.index));
          });
        }
      }, 100);
    });
  </script>
</body>

</html>
